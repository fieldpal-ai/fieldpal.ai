{% extends "admin/base.html" %}

{% block title %}Content Management - Admin{% endblock %}

{% block content %}
<div class="bg-white shadow rounded-lg p-6">
    <h1 class="text-2xl font-bold text-gray-900 mb-6">Content Management</h1>
    
    <div class="mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Homepage Sections</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="loadSection('hero')">
                <h3 class="text-lg font-semibold mb-2">Hero Section</h3>
                <p class="text-sm text-gray-600">Main title and subtitle</p>
            </div>
            
            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="loadSection('stats')">
                <h3 class="text-lg font-semibold mb-2">Stats Section</h3>
                <p class="text-sm text-gray-600">Key statistics</p>
            </div>
            
            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="loadSection('what-we-do')">
                <h3 class="text-lg font-semibold mb-2">What We Do</h3>
                <p class="text-sm text-gray-600">Main feature section</p>
            </div>
            
            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="loadSection('problem')">
                <h3 class="text-lg font-semibold mb-2">Problem Section</h3>
                <p class="text-sm text-gray-600">The challenge heading</p>
            </div>
            
            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="loadSection('challenges')">
                <h3 class="text-lg font-semibold mb-2">Challenges Features</h3>
                <p class="text-sm text-gray-600">4 challenge cards</p>
            </div>
            
            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="loadSection('capture-module')">
                <h3 class="text-lg font-semibold mb-2">Capture Module</h3>
                <p class="text-sm text-gray-600">Product features</p>
            </div>
            
            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="loadSection('faq')">
                <h3 class="text-lg font-semibold mb-2">FAQ Section</h3>
                <p class="text-sm text-gray-600">Questions and answers</p>
            </div>
        </div>
    </div>
    
    <div id="editor" class="hidden mt-6 border-t pt-6">
        <div class="mb-4">
            <h3 id="sectionTitle" class="text-xl font-semibold mb-2"></h3>
            <p id="sectionDescription" class="text-sm text-gray-600 mb-4"></p>
        </div>
        
        <div id="formFields" class="space-y-4">
            <!-- Form fields will be dynamically generated here -->
        </div>
        
        <div class="mt-6 flex gap-4">
            <button onclick="saveSection()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                Save Changes
            </button>
            <button onclick="cancelEdit()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
let currentSection = null;
let currentData = {};

// Section configurations
const sectionConfigs = {
    'hero': {
        title: 'Hero Section',
        description: 'Main title and subtitle at the top of the homepage',
        fields: [
            { key: 'subtitle', label: 'Subtitle', type: 'text', placeholder: 'Real work. Real time. Real AI.' },
            { key: 'title', label: 'Main Heading', type: 'textarea', placeholder: 'Voice-first AI for Frontline Workers - capture, find and fix in minutes.' }
        ]
    },
    'stats': {
        title: 'Stats Section',
        description: 'Key statistics displayed below the video',
        fields: [
            { key: 'stats[0].number', label: 'Stat 1 - Number', type: 'text', placeholder: '40%' },
            { key: 'stats[0].label', label: 'Stat 1 - Label', type: 'text', placeholder: 'Downtime cut' },
            { key: 'stats[1].number', label: 'Stat 2 - Number', type: 'text', placeholder: '60%' },
            { key: 'stats[1].label', label: 'Stat 2 - Label', type: 'text', placeholder: 'Faster access' },
            { key: 'stats[2].number', label: 'Stat 3 - Number', type: 'text', placeholder: '80%' },
            { key: 'stats[2].label', label: 'Stat 3 - Label', type: 'text', placeholder: 'Training speed' },
            { key: 'stats[3].number', label: 'Stat 4 - Number', type: 'text', placeholder: '3-4' },
            { key: 'stats[3].label', label: 'Stat 4 - Label', type: 'text', placeholder: 'Months to ROI' }
        ]
    },
    'what-we-do': {
        title: 'What We Do Section',
        description: 'Main feature section with list items',
        fields: [
            { key: 'title', label: 'Section Title', type: 'text', placeholder: 'What We Do' },
            { key: 'heading', label: 'Heading', type: 'textarea', placeholder: 'Harness the power of AI for frontline operations.' },
            { key: 'body', label: 'Body Text', type: 'textarea', placeholder: 'FieldPal provides customised AI solutions...' },
            { key: 'list_items', label: 'List Items (one per line)', type: 'textarea', placeholder: 'Voice-first data capture and analysis\nLegacy system integration...' },
            { key: 'button_text', label: 'Button Text', type: 'text', placeholder: 'Get in touch' }
        ]
    },
    'problem': {
        title: 'Problem Section',
        description: 'The challenge heading section',
        fields: [
            { key: 'title', label: 'Title', type: 'text', placeholder: 'The Problem We Solve' },
            { key: 'heading', label: 'Heading', type: 'textarea', placeholder: 'The challenge holding Industrial Operations Back' }
        ]
    },
    'challenges': {
        title: 'Challenges Features',
        description: 'Four challenge cards with title, heading, and body text',
        fields: [
            { key: 'challenges[0].title', label: 'Challenge 1 - Title', type: 'text', placeholder: 'Unplanned Downtime' },
            { key: 'challenges[0].heading', label: 'Challenge 1 - Heading', type: 'text', placeholder: '5M+' },
            { key: 'challenges[0].body', label: 'Challenge 1 - Body', type: 'textarea', placeholder: '£5M+ in annual losses...' },
            { key: 'challenges[1].title', label: 'Challenge 2 - Title', type: 'text', placeholder: 'Knowledge Loss' },
            { key: 'challenges[1].heading', label: 'Challenge 2 - Heading', type: 'text', placeholder: '20+ Years' },
            { key: 'challenges[1].body', label: 'Challenge 2 - Body', type: 'textarea', placeholder: '20+ years of expertise...' },
            { key: 'challenges[2].title', label: 'Challenge 3 - Title', type: 'text', placeholder: 'Data Silos' },
            { key: 'challenges[2].heading', label: 'Challenge 3 - Heading', type: 'text', placeholder: '60%' },
            { key: 'challenges[2].body', label: 'Challenge 3 - Body', type: 'textarea', placeholder: 'Workers waste up to 60%...' },
            { key: 'challenges[3].title', label: 'Challenge 4 - Title', type: 'text', placeholder: 'Safety & Compliance Risk' },
            { key: 'challenges[3].heading', label: 'Challenge 4 - Heading', type: 'text', placeholder: '99.7%' },
            { key: 'challenges[3].body', label: 'Challenge 4 - Body', type: 'textarea', placeholder: '99.7% accuracy and consistency...' }
        ]
    },
    'capture-module': {
        title: 'Capture Module Section',
        description: 'Product features and technology section',
        fields: [
            { key: 'subtitle', label: 'Subtitle', type: 'text', placeholder: 'Capture Module' },
            { key: 'heading', label: 'Heading', type: 'text', placeholder: 'Hands-free, conversational capture' },
            { key: 'body', label: 'Body Text', type: 'textarea', placeholder: 'Record tasks and observations...' },
            { key: 'list_items', label: 'Feature List (one per line)', type: 'textarea', placeholder: 'Captures work even in noisy environments\nAuto-tags entries...' },
            { key: 'tech_subtitle', label: 'Tech Subtitle', type: 'text', placeholder: 'Technology' },
            { key: 'tech_heading', label: 'Tech Heading', type: 'text', placeholder: 'Core tech that powers FieldPal' },
            { key: 'tech_features[0].heading', label: 'Tech Feature 1 - Heading', type: 'text', placeholder: 'Micro-indexing technology' },
            { key: 'tech_features[0].text', label: 'Tech Feature 1 - Text', type: 'textarea', placeholder: 'Sub-second indexing...' },
            { key: 'tech_features[1].heading', label: 'Tech Feature 2 - Heading', type: 'text', placeholder: 'Human-centred design' },
            { key: 'tech_features[1].text', label: 'Tech Feature 2 - Text', type: 'textarea', placeholder: 'Voice-first UX...' },
            { key: 'tech_features[2].heading', label: 'Tech Feature 3 - Heading', type: 'text', placeholder: 'Contextual intelligence' },
            { key: 'tech_features[2].text', label: 'Tech Feature 3 - Text', type: 'textarea', placeholder: 'Answers tailored...' },
            { key: 'tech_features[3].heading', label: 'Tech Feature 4 - Heading', type: 'text', placeholder: 'API-first platform' },
            { key: 'tech_features[3].text', label: 'Tech Feature 4 - Text', type: 'textarea', placeholder: 'Restful APIs...' }
        ]
    },
    'faq': {
        title: 'FAQ Section',
        description: 'Frequently asked questions',
        fields: [
            { key: 'title', label: 'FAQ Title', type: 'text', placeholder: 'Understanding FieldPal.ai' },
            { key: 'questions[0].question', label: 'FAQ 1 - Question', type: 'text', placeholder: 'What is FieldPal.ai?' },
            { key: 'questions[0].answer', label: 'FAQ 1 - Answer', type: 'textarea', placeholder: 'FieldPal.ai is an AI-driven platform...' },
            { key: 'questions[1].question', label: 'FAQ 2 - Question', type: 'text', placeholder: 'Who uses FieldPal.ai?' },
            { key: 'questions[1].answer', label: 'FAQ 2 - Answer', type: 'textarea', placeholder: 'Organisations with field-facing operations...' },
            { key: 'questions[2].question', label: 'FAQ 3 - Question', type: 'text', placeholder: 'What problems does FieldPal.ai solve?' },
            { key: 'questions[2].answer', label: 'FAQ 3 - Answer', type: 'textarea', placeholder: 'It reduces asset downtime...' },
            { key: 'questions[3].question', label: 'FAQ 4 - Question', type: 'text', placeholder: 'How does FieldPal.ai work with our existing systems?' },
            { key: 'questions[3].answer', label: 'FAQ 4 - Answer', type: 'textarea', placeholder: 'FieldPal.ai is API-first...' },
            { key: 'questions[4].question', label: 'FAQ 5 - Question', type: 'text', placeholder: 'Is FieldPal.ai secure and enterprise-grade?' },
            { key: 'questions[4].answer', label: 'FAQ 5 - Answer', type: 'textarea', placeholder: 'Yes — FieldPal.ai is designed...' },
            { key: 'questions[5].question', label: 'FAQ 6 - Question', type: 'text', placeholder: 'Can field workers use FieldPal.ai offline?' },
            { key: 'questions[5].answer', label: 'FAQ 6 - Answer', type: 'textarea', placeholder: 'FieldPal.ai supports mobile-first workflows...' },
            { key: 'questions[6].question', label: 'FAQ 7 - Question', type: 'text', placeholder: 'How long does implementation take?' },
            { key: 'questions[6].answer', label: 'FAQ 7 - Answer', type: 'textarea', placeholder: 'Implementation time depends...' },
            { key: 'questions[7].question', label: 'FAQ 8 - Question', type: 'text', placeholder: 'How is FieldPal.ai priced?' },
            { key: 'questions[7].answer', label: 'FAQ 8 - Answer', type: 'textarea', placeholder: 'Pricing varies by number of users...' },
            { key: 'questions[8].question', label: 'FAQ 9 - Question', type: 'text', placeholder: 'What support and onboarding do you offer?' },
            { key: 'questions[8].answer', label: 'FAQ 9 - Answer', type: 'textarea', placeholder: 'Onboarding includes implementation support...' }
        ]
    }
};

async function loadSection(section) {
    currentSection = section;
    const config = sectionConfigs[section];
    
    if (!config) {
        alert('Unknown section: ' + section);
        return;
    }
    
    // Update UI
    document.getElementById('sectionTitle').textContent = config.title;
    document.getElementById('sectionDescription').textContent = config.description;
    
    // Load current content
    try {
        const response = await fetch(`/api/content/home?section=${section}`, {
            credentials: 'include'
        });
        
        let data = {};
        if (response.ok) {
            const result = await response.json();
            data = result.content || {};
        }
        
        currentData = data;
        
        // Generate form fields
        const formFields = document.getElementById('formFields');
        formFields.innerHTML = '';
        
        config.fields.forEach(field => {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'mb-4';
            
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium text-gray-700 mb-1';
            label.textContent = field.label;
            label.setAttribute('for', field.key.replace(/[\[\].]/g, '_'));
            
            let input;
            if (field.type === 'textarea') {
                input = document.createElement('textarea');
                input.rows = field.key.includes('body') || field.key.includes('answer') ? 4 : 2;
            } else {
                input = document.createElement('input');
                input.type = field.type;
            }
            
            input.id = field.key.replace(/[\[\].]/g, '_');
            input.className = 'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500';
            input.placeholder = field.placeholder;
            
            // Get value from nested data structure
            const value = getNestedValue(data, field.key);
            if (value !== undefined && value !== null) {
                input.value = value;
            }
            
            fieldDiv.appendChild(label);
            fieldDiv.appendChild(input);
            formFields.appendChild(fieldDiv);
        });
        
        document.getElementById('editor').classList.remove('hidden');
        document.getElementById('editor').scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        console.error('Error loading section:', error);
        alert('Error loading section: ' + error.message);
    }
}

function getNestedValue(obj, path) {
    const keys = path.replace(/\[(\d+)\]/g, '.$1').split('.').filter(k => k);
    let value = obj;
    for (const key of keys) {
        if (value && typeof value === 'object' && key in value) {
            value = value[key];
        } else {
            return undefined;
        }
    }
    return value;
}

function setNestedValue(obj, path, value) {
    const keys = path.replace(/\[(\d+)\]/g, '.$1').split('.').filter(k => k);
    const lastKey = keys.pop();
    let current = obj;
    
    for (const key of keys) {
        if (!(key in current) || typeof current[key] !== 'object') {
            current[key] = isNaN(parseInt(keys[keys.indexOf(key) + 1])) ? {} : [];
        }
        current = current[key];
    }
    
    current[lastKey] = value;
}

async function saveSection() {
    if (!currentSection) return;
    
    const config = sectionConfigs[currentSection];
    const data = {};
    
    // Collect form values
    config.fields.forEach(field => {
        const inputId = field.key.replace(/[\[\].]/g, '_');
        const input = document.getElementById(inputId);
        if (input) {
            let value = input.value.trim();
            
            // Handle special cases
            if (field.key === 'list_items') {
                value = value.split('\n').filter(line => line.trim());
            }
            
            setNestedValue(data, field.key, value);
        }
    });
    
    try {
        const token = getCookie('auth_token');
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch(`/api/content/home?section=${currentSection}`, {
            method: 'PUT',
            headers: headers,
            credentials: 'include',
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Content saved successfully!');
            currentData = data;
        } else {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
    } catch (error) {
        console.error('Error saving section:', error);
        alert('Error saving content: ' + error.message);
    }
}

function cancelEdit() {
    document.getElementById('editor').classList.add('hidden');
    currentSection = null;
    currentData = {};
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}
</script>
{% endblock %}
