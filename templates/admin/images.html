{% extends "admin/base.html" %}

{% block title %}Image Management - Admin{% endblock %}

{% block content %}
<div class="bg-white shadow rounded-lg p-6">
    <h1 class="text-2xl font-bold text-gray-900 mb-6">Image Management</h1>
    
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
        <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
        <button onclick="uploadImage()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Upload</button>
    </div>
    
    <div id="imageGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <!-- Images will be loaded here -->
    </div>
</div>

<script>
// Helper function to get cookie value
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

async function loadImages() {
    try {
        const token = getCookie('auth_token');
        const headers = {};
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch('/api/images', {
            headers: headers,
            credentials: 'include'  // Include cookies
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        const grid = document.getElementById('imageGrid');
        grid.innerHTML = '';
        
        data.images.forEach(image => {
            const div = document.createElement('div');
            div.className = 'border rounded p-2';
            div.innerHTML = `
                <img src="${image.url}" alt="${image.name}" class="w-full h-32 object-cover rounded">
                <p class="text-xs mt-2 truncate">${image.name}</p>
                <button onclick="deleteImage('${image.name}')" class="mt-2 text-red-600 hover:text-red-800 text-xs">Delete</button>
            `;
            grid.appendChild(div);
        });
    } catch (error) {
        console.error('Error loading images:', error);
        alert('Error loading images: ' + error.message);
    }
}

async function uploadImage() {
    const fileInput = document.getElementById('imageUpload');
    if (!fileInput.files[0]) return;
    
    try {
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        const token = getCookie('auth_token');
        
        const headers = {};
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch('/api/images/upload', {
            method: 'POST',
            headers: headers,
            credentials: 'include',  // Include cookies
            body: formData
        });
        
        if (response.ok) {
            alert('Image uploaded successfully!');
            loadImages();
            fileInput.value = '';
        } else {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
    } catch (error) {
        console.error('Error uploading image:', error);
        alert('Error uploading image: ' + error.message);
    }
}

async function deleteImage(imageName) {
    if (!confirm('Are you sure you want to delete this image?')) return;
    
    try {
        const token = getCookie('auth_token');
        const headers = {};
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch(`/api/images/${imageName}`, {
            method: 'DELETE',
            headers: headers,
            credentials: 'include'  // Include cookies
        });
        
        if (response.ok) {
            alert('Image deleted successfully!');
            loadImages();
        } else {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
    } catch (error) {
        console.error('Error deleting image:', error);
        alert('Error deleting image: ' + error.message);
    }
}

// Load images on page load
loadImages();
</script>
{% endblock %}

